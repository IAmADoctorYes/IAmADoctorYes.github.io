name: Sync Content

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: content-sync
  cancel-in-progress: true

jobs:
  sync-content:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    env:
      PYTHON_VERSION: "3.11"
      STATE_FILE: scripts/sync-state.json
      BLOG_DIR: pages/blog
      BACKGROUND_DIR: assets/backgrounds

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-api-python-client beautifulsoup4 requests python-dateutil

      - name: Restore state cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STATE_FILE }}
          key: sync-state-${{ runner.os }}-${{ hashFiles('scripts/sync-google-docs.py') }}
          restore-keys: |
            sync-state-${{ runner.os }}-

      - name: Ensure directories
        run: |
          mkdir -p scripts
          mkdir -p "$BLOG_DIR"
          mkdir -p "$BACKGROUND_DIR"

      - name: Create credentials file
        run: |
          echo "${{ secrets.GOOGLE_DRIVE_CREDS }}" | base64 --decode > creds.json
          test -s creds.json || (echo "Credentials file empty!" && exit 1)

      - name: Sync Google Docs → Blog artifacts
        env:
          GOOGLE_DOCS_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
          GOOGLE_APPLICATION_CREDENTIALS: creds.json
        run: |
          python scripts/sync-google-docs.py

      - name: Fetch background images
        run: |
          if [ -f scripts/fetch-backgrounds.py ]; then
            python scripts/fetch-backgrounds.py
          else
            echo "No background script found — skipping."
          fi

      - name: Commit generated artifacts
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          if [[ -n "$(git status --porcelain)" ]]; then
            git add "$BLOG_DIR" assets/search-index.json pages/blog.html "$BACKGROUND_DIR" "$STATE_FILE"
            git commit -m "Auto: Refresh generated content artifacts"
            git push
          else
            echo "No changes to commit."
          fi
