name: Sync Google Docs to Blog

on:
  schedule:
    - cron: "0 */6 * * *"   # every 6 hours
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: google-docs-sync
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    env:
      PYTHON_VERSION: "3.11"
      STATE_FILE: scripts/sync-state.json
      BLOG_DIR: pages/blog
      BACKGROUND_DIR: assets/backgrounds

    steps:
    # ---------------------------------------------------------
    # Checkout repo
    # ---------------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # ---------------------------------------------------------
    # Setup Python + pip cache
    # ---------------------------------------------------------
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: "pip"
    - uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip
    # ---------------------------------------------------------
    # Install dependencies (deterministic)
    # ---------------------------------------------------------
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install google-api-python-client beautifulsoup4 requests python-dateutil

    # ---------------------------------------------------------
    # Restore sync state cache
    # ---------------------------------------------------------
    - name: Restore state cache
      uses: actions/cache@v4
      with:
        path: ${{ env.STATE_FILE }}
        key: sync-state-${{ runner.os }}-${{ hashFiles('scripts/sync-google-docs.py') }}
        restore-keys: |
          sync-state-${{ runner.os }}-

    # ---------------------------------------------------------
    # Ensure required folders exist
    # ---------------------------------------------------------
    - name: Ensure directories
      run: |
        mkdir -p scripts
        mkdir -p $BLOG_DIR
        mkdir -p $BACKGROUND_DIR

    # ---------------------------------------------------------
    # Create Google credentials file
    # ---------------------------------------------------------
    - name: Create credentials file
      run: |
        echo "${{ secrets.GOOGLE_DRIVE_CREDS }}" | base64 --decode > creds.json
        test -s creds.json || (echo "Credentials file empty!" && exit 1)

    # ---------------------------------------------------------
    # Run sync script
    # ---------------------------------------------------------
    - name: Sync Google Docs → Blog
      env:
        DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
        CREDS_FILE: creds.json
      run: |
        python scripts/sync-google-docs.py

    # ---------------------------------------------------------
    # Fetch background images (optional step)
    # Will not fail workflow if script intentionally exits 0
    # ---------------------------------------------------------
    - name: Fetch background images
      run: |
        if [ -f scripts/fetch-backgrounds.py ]; then
          python scripts/fetch-backgrounds.py
        else
          echo "No background script found — skipping."
        fi

    # ---------------------------------------------------------
    # Commit changes if any exist
    # ---------------------------------------------------------
    - name: Commit changes
      run: |
        git config user.name "github-actions"
        git config user.email "actions@github.com"

        if [[ -n "$(git status --porcelain)" ]]; then
          git add $BLOG_DIR pages/blog.html assets/search-index.json $BACKGROUND_DIR $STATE_FILE
          git commit -m "Auto: Sync Google Docs"
          git push
        else
          echo "No changes to commit."
        fi

